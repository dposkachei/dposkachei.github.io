angular.module("angucomplete",[]).directive("angucomplete",function(a,b,c,d){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",posturl:"@posturl",dataField:"@datafield",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",imageUri:"@imageuri",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength",matchClass:"@matchclass"},template:'<form action="{{posturl + idUrl}}" method="GET"><div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" autocomplete="off" placeholder="{{placeholder}}" class="{{inputClass}}" onmouseup="this.select();" ng-focus="resetHideResults()" ng-blur="hideResults()" /><button type="submit" class="btn-flat search-button" ng-if="searchButton"><i class="material-icons">&#xE8B6;</i></button><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">\u0418\u0434\u0435\u0442 \u043f\u043e\u0438\u0441\u043a...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">\u0413\u0440\u0443\u043f\u0430 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u0430</div><div class="angucomplete-row" ng-repeat="result in results" ng-mousedown="selectResult(result)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="imageField" class="angucomplete-image-holder"><img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/><div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div></div><div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div><div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div><form>',link:function(a,e,f){a.lastSearchTerm=null,a.currentIndex=null,a.justChanged=!1,a.searchTimer=null,a.hideTimer=null,a.searching=!1,a.pause=500,a.minLength=3,a.searchStr=null,a.idUrl=null,a.searchButton=!1,a.minLengthUser&&""!=a.minLengthUser&&(a.minLength=a.minLengthUser),a.userPause&&(a.pause=a.userPause),isNewSearchNeeded=function(b,c){return b.length>=a.minLength&&b!=c},a.processResults=function(b,d){if(b&&b.length>0){a.results=[];var e=[];a.titleField&&""!=a.titleField&&(e=a.titleField.split(","));for(var f=0;f<b.length;f++){for(var g=[],h=0;h<e.length;h++)g.push(b[f][e[h]]);var i="";a.descriptionField&&(i=b[f][a.descriptionField]);var j="";a.imageUri&&(j=a.imageUri);var k="";a.imageField&&(k=j+b[f][a.imageField]);var l=g.join(" ");if(a.matchClass){var m=new RegExp(d,"i"),n=l.match(m)[0];l=c.trustAsHtml(l.replace(m,'<span class="'+a.matchClass+'">'+n+"</span>"))}var o={title:l,description:i,image:k,originalObject:b[f]};a.results[a.results.length]=o,1==b.length&&(a.idUrl=b[f].group_url_title)}}else a.results=[],a.searchButton=!1},a.searchTimerComplete=function(c){if(c.length>=a.minLength)if(a.localData){for(var d=a.searchFields.split(","),e=[],f=0;f<a.localData.length;f++){for(var g=!1,h=0;h<d.length;h++)g=g||"string"==typeof a.localData[f][d[h]]&&"string"==typeof c&&a.localData[f][d[h]].toLowerCase().indexOf(c.toLowerCase())>=0;g&&(e[e.length]=a.localData[f])}a.searching=!1,console.log(a.searching),a.processResults(e,c)}else b.get(a.url+c,{}).success(function(b,d,e,f){a.searching=!1,console.log(b),a.processResults(b,c)}).error(function(a,b,c,d){console.log("error")})},a.hideResults=function(){a.hideTimer=d(function(){a.showDropdown=!1},a.pause)},a.resetHideResults=function(){a.hideTimer&&d.cancel(a.hideTimer)},a.hoverRow=function(b){a.currentIndex=b},a.keyPressed=function(b){38!=b.which&&40!=b.which&&13!=b.which?a.searchStr&&""!=a.searchStr?isNewSearchNeeded(a.searchStr,a.lastSearchTerm)&&(a.lastSearchTerm=a.searchStr,a.showDropdown=!0,a.currentIndex=-1,a.results=[],a.searchTimer&&d.cancel(a.searchTimer),a.searching=!0,a.searchTimer=d(function(){a.searchTimerComplete(a.searchStr)},a.pause)):(a.showDropdown=!1,a.lastSearchTerm=null,a.searchButton=!1):b.preventDefault()},a.selectResult=function(b){a.matchClass&&(b.title=b.title.toString().replace(/(<([^>]+)>)/gi,"")),a.searchStr=a.lastSearchTerm=b.title,a.selectedObject=b,a.idUrl=b.originalObject.group_url_title,a.searchButton=!0,a.showDropdown=!1,a.results=[]},a.preselectResult=function(b){a.matchClass&&(b.title=b.title.toString().replace(/(<([^>]+)>)/gi,"")),a.searchStr=a.lastSearchTerm=b.title,a.selectedObject=b,a.idUrl=b.originalObject.group_url_title,a.searchButton=!0};var g=e.find("input");g.on("keyup",a.keyPressed),e.on("keyup",function(b){40===b.which?(a.results&&a.currentIndex+1<a.results.length&&(a.currentIndex++,a.preselectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()),a.$apply()):38==b.which?a.currentIndex>=1&&(a.currentIndex--,a.preselectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()):13==b.which?a.results&&a.currentIndex>=0&&a.currentIndex<a.results.length?(a.selectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()):(a.results=[],a.$apply(),b.preventDefault,b.stopPropagation()):27==b.which?(a.results=[],a.showDropdown=!1,a.searchButton=!1,a.$apply()):8==b.which&&(a.selectedObject=null,a.$apply())})}}});